<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>RVT Receipts</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { padding-top: 40px; background-color: #111; color: #eee; }
    .logo { font-size: 32px; font-weight: bold; letter-spacing: 4px; color: #0f0; }
    .panel { background-color: #1b1b1b; border-color: #333; }
    .panel-heading { background-color: #222 !important; border-color: #333 !important; color: #0f0 !important; }
    .form-control, .btn { background-color: #222; border-color: #444; color: #eee; }
    .form-control:focus { border-color: #0f0; box-shadow: none; }
    .btn-primary { background-color: #0f0; border-color: #0f0; color: #000; }
    .btn-success { background-color: #09c709; border-color: #09c709; color: #000; }
    .btn-warning { background-color: #ff9800; border-color: #ff9800; color: #000; }
    .hidden { display: none; }
    .balance { font-size: 20px; font-weight: bold; color: #0f0; }
    a, a:hover, a:focus { color: #0f0; }
    #receipt-result { min-height: 40px; }
    
    /* Receipt Frame */
    .receipt-frame {
      border: 3px solid #0f0;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      background: #222;
      text-align: center;
      position: relative;
      min-height: 300px;
    }
    .store-name {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      background: #0f0;
      color: #000;
      padding: 5px;
      font-weight: bold;
      text-align: center;
      border-radius: 3px;
      z-index: 10;
    }
    #receipt-preview {
      max-width: 100%;
      max-height: 250px;
      margin: 20px 0;
    }
    .upload-area {
      padding: 40px;
      cursor: pointer;
      color: #888;
      position: relative;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .upload-area:hover {
      background: #2a2a2a;
    }
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      cursor: pointer;
      width: 100%;
      height: 100%;
    }
    .upload-icon {
      font-size: 48px;
      margin-bottom: 10px;
      color: #0f0;
    }
    .alert {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .alert-success {
      background: #155724;
      color: #d4edda;
      border: 1px solid #c3e6cb;
    }
    .alert-danger {
      background: #721c24;
      color: #f8d7da;
      border: 1px solid #f5c6cb;
    }
    .alert-info {
      background: #0c5460;
      color: #d1ecf1;
      border: 1px solid #bee5eb;
    }
    .history-item {
      border-bottom: 1px solid #333;
      padding: 8px 0;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="text-center">
    <div class="logo">RVT RECEIPTS</div>
    <p>Upload receipts, earn points, cash out rewards</p>
  </div>

  <!-- Login -->
  <div id="login-panel" class="panel panel-default">
    <div class="panel-heading">Login</div>
    <div class="panel-body text-center">
      <form id="login-form">
        <input id="username" class="form-control" style="width:200px;display:inline;" placeholder="Username" required>
        <input id="password" class="form-control" type="password" style="width:200px;display:inline;" placeholder="Password" required>
        <button type="submit" class="btn btn-primary">Login</button>
      </form>
      <div id="login-error" class="text-danger" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">
    <div class="panel panel-default">
      <div class="panel-heading clearfix">
        Welcome, <span id="welcome-user"></span>
        <span class="pull-right balance">Balance: <span id="balance-value">0</span> pts</span>
      </div>
      <div class="panel-body">
        <div class="row">
          <div class="col-md-6">
            <!-- Receipt Upload -->
            <div class="panel panel-default">
              <div class="panel-heading">Upload Receipt</div>
              <div class="panel-body">
                <div class="receipt-frame">
                  <div id="store-name-display" class="store-name hidden">Store: <span id="detected-store">Unknown</span></div>
                  
                  <!-- FIXED UPLOAD AREA - Now clickable! -->
                  <div class="file-input-wrapper">
                    <div id="upload-area" class="upload-area">
                      <div class="upload-icon">ðŸ“·</div>
                      <strong>Click to upload receipt</strong><br>
                      JPG, PNG, HEIC accepted<br>
                      <small>Max 5MB</small>
                    </div>
                    <input type="file" id="receipt-image" accept="image/*">
                  </div>
                  
                  <img id="receipt-preview" class="hidden">
                  <div id="processing" class="hidden">
                    <div style="color:#0f0; margin:20px;">
                      <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">
                        <span class="sr-only">Processing...</span>
                      </div>
                      <div>Processing receipt...</div>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label>Select Bonus Offer (Optional)</label>
                  <select id="offer-type" class="form-control">
                    <option value="">No offer</option>
                  </select>
                </div>
                
                <button id="submit-receipt" class="btn btn-success btn-block" disabled>Process Receipt & Earn Points</button>
                <div id="result-message" style="margin-top:10px;"></div>
              </div>
            </div>
            
            <!-- Cashout -->
            <div class="panel panel-default">
              <div class="panel-heading">Cash Out Points</div>
              <div class="panel-body">
                <p>100 points = $1.00</p>
                <div class="form-group">
                  <label>Amount (points)</label>
                  <input type="number" id="cashout-amount" class="form-control" value="1000" min="100">
                </div>
                <div class="form-group">
                  <label>PayPal Email</label>
                  <input type="email" id="paypal-email" class="form-control" placeholder="your@email.com">
                </div>
                <button id="submit-cashout" class="btn btn-warning btn-block">Request Cashout</button>
                <div id="cashout-message" style="margin-top:10px;"></div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <!-- Offers -->
            <div class="panel panel-default">
              <div class="panel-heading">
                Bonus Offers
                <button id="add-offer-btn" class="btn btn-xs btn-primary pull-right">Add Offer</button>
              </div>
              <div class="panel-body">
                <div id="active-offers">
                  <div class="text-muted">Loading offers...</div>
                </div>
                
                <!-- Add Offer Form -->
                <div id="add-offer-form" class="hidden" style="margin-top:20px;">
                  <h5>Add New Offer</h5>
                  <input type="text" id="new-offer-name" class="form-control" placeholder="Offer Name" style="margin-bottom:5px;">
                  <input type="number" id="new-offer-points" class="form-control" placeholder="Points" style="margin-bottom:5px;">
                  <button id="save-offer" class="btn btn-primary btn-block">Save Offer</button>
                </div>
              </div>
            </div>
            
            <!-- History -->
            <div class="panel panel-default">
              <div class="panel-heading">Recent Receipts</div>
              <div class="panel-body" style="max-height:300px;overflow-y:auto;">
                <div id="receipt-history">
                  <div class="text-muted">No receipts yet</div>
                </div>
              </div>
            </div>
            
            <!-- Logout -->
            <button id="logout-btn" class="btn btn-default btn-block">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script>
// ==============================================
// CONFIG
// ==============================================
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyED75I7fLhO119evsRGXwDhQftAYe5_dQwY8T9bhZtEh09OfhCe7rGSgYFOfIh7JVyRw/exec";
let currentUser = null;

// ==============================================
// API CALL FUNCTION
// ==============================================
async function callAPI(action, data = {}) {
  try {
    console.log('API Call:', action, data);
    
    const params = new URLSearchParams();
    params.append('action', action);
    
    for (const key in data) {
      if (data[key] !== null && data[key] !== undefined) {
        params.append(key, data[key].toString());
      }
    }
    
    const response = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: params,
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    });
    
    const responseText = await response.text();
    console.log('Response:', responseText);
    
    try {
      return JSON.parse(responseText);
    } catch (e) {
      console.error('Failed to parse JSON:', responseText);
      return {status: 'error', message: 'Invalid server response'};
    }
    
  } catch (error) {
    console.error('API Error:', error);
    return {status: 'error', message: 'Network error'};
  }
}

// ==============================================
// LOGIN SYSTEM
// ==============================================
$('#login-form').on('submit', async function(e) {
  e.preventDefault();
  
  const username = $('#username').val().trim();
  const password = $('#password').val().trim();
  
  if (!username || !password) {
    showError('login-error', 'Enter username and password');
    return;
  }
  
  showError('login-error', 'Logging in...');
  
  const result = await callAPI('login', {username, password});
  
  if (result.status === 'success') {
    currentUser = result.user;
    
    // Update UI
    $('#welcome-user').text(currentUser.name || currentUser.username);
    $('#balance-value').text(currentUser.balance || 0);
    $('#login-panel').addClass('hidden');
    $('#dashboard').removeClass('hidden');
    showError('login-error', '');
    
    // Load data
    loadOffers();
    loadReceiptHistory();
    
    // Initialize system
    await callAPI('initialize');
    
  } else {
    showError('login-error', result.message || 'Login failed');
  }
});

// ==============================================
// FILE UPLOAD - FIXED!
// ==============================================
// Make upload area clickable
$('#upload-area').on('click', function() {
  $('#receipt-image').trigger('click');
});

// Handle file selection
$('#receipt-image').on('change', async function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  console.log('File selected:', file.name, file.size);
  
  // Validate file
  if (file.size > 5 * 1024 * 1024) {
    showMessage('result-message', 'File too large (max 5MB)', 'error');
    return;
  }
  
  // Show preview
  const reader = new FileReader();
  reader.onload = function(e) {
    $('#receipt-preview')
      .attr('src', e.target.result)
      .removeClass('hidden');
    $('#upload-area').addClass('hidden');
  };
  reader.readAsDataURL(file);
  
  // Process OCR
  $('#processing').removeClass('hidden');
  $('#submit-receipt').prop('disabled', true);
  
  try {
    // Convert HEIC if needed
    let processedFile = file;
    if (file.name.toLowerCase().endsWith('.heic') || file.type.includes('heic')) {
      processedFile = await convertHeicToJpg(file);
    }
    
    // Perform OCR
    const ocrResult = await performOCR(processedFile);
    
    // Display store name
    $('#detected-store').text(ocrResult.storeName);
    $('#store-name-display').removeClass('hidden');
    
    // Store OCR data
    $('#submit-receipt').data('ocr', ocrResult);
    
    // Check if receipt is valid
    if (!isWithin7Days(ocrResult.date)) {
      showMessage('result-message', 'Receipt is older than 7 days', 'error');
    } else {
      $('#submit-receipt').prop('disabled', false);
    }
    
  } catch (error) {
    console.error('OCR Error:', error);
    showMessage('result-message', 'Error processing image: ' + error.message, 'error');
  } finally {
    $('#processing').addClass('hidden');
  }
});

// OCR Function
async function performOCR(file) {
  const worker = await Tesseract.createWorker('eng', 1);
  const { data } = await worker.recognize(file);
  await worker.terminate();
  
  const text = data.text || '';
  console.log('OCR Text:', text.substring(0, 200));
  
  // Extract store name
  const lines = text.split('\n').filter(line => line.trim());
  let storeName = lines[0] || 'Unknown Store';
  
  // Look for common stores
  const storePatterns = ['WALMART', 'TARGET', 'COSTCO', 'AMAZON', 'STARBUCKS', 'CVS', 'WALGREENS'];
  for (const line of lines) {
    for (const pattern of storePatterns) {
      if (line.toUpperCase().includes(pattern)) {
        storeName = line.trim();
        break;
      }
    }
    if (storeName !== 'Unknown Store') break;
  }
  
  // Extract date
  let date = null;
  const dateMatch = text.match(/\b(\d{1,2})[-\/](\d{1,2})[-\/](\d{2,4})\b/);
  if (dateMatch) {
    const month = dateMatch[1].padStart(2, '0');
    const day = dateMatch[2].padStart(2, '0');
    const year = dateMatch[3].length === 2 ? '20' + dateMatch[3] : dateMatch[3];
    date = `${year}-${month}-${day}`;
  }
  
  // Extract total
  let total = 0;
  const totalMatch = text.match(/total\s*[\$]?\s*([\d,]+\.\d{2})/i) ||
                    text.match(/amount\s*[\$]?\s*([\d,]+\.\d{2})/i) ||
                    text.match(/[\$](\d+\.\d{2})\b/);
  
  if (totalMatch) {
    total = parseFloat(totalMatch[1].replace(/,/g, ''));
  }
  
  return {storeName, date, total, fullText: text};
}

// HEIC Converter
async function convertHeicToJpg(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        
        canvas.toBlob(blob => {
          resolve(new File([blob], file.name.replace(/\.heic$/i, '.jpg'), {type: 'image/jpeg'}));
        }, 'image/jpeg', 0.9);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

// Date validation
function isWithin7Days(dateString) {
  if (!dateString) return false;
  const receiptDate = new Date(dateString);
  if (isNaN(receiptDate.getTime())) return false;
  
  const today = new Date();
  const diffTime = today - receiptDate;
  const diffDays = diffTime / (1000 * 60 * 60 * 24);
  return diffDays <= 14 && diffDays >= 0;
}

// Points calculation
function calculatePoints(total) {
  if (total <= 0) return 0;
  if (total < 50) return 5;
  if (total < 100) return 25;
  return 50;
}

// ==============================================
// SUBMIT RECEIPT
// ==============================================
$('#submit-receipt').on('click', async function() {
  const ocrData = $(this).data('ocr');
  if (!ocrData) {
    showMessage('result-message', 'Please upload a receipt first', 'error');
    return;
  }
  
  // Validate date
  if (!isWithin7Days(ocrData.date)) {
    showMessage('result-message', 'Receipt is older than 7 days', 'error');
    return;
  }
  
  // Calculate points
  const basePoints = calculatePoints(ocrData.total);
  let bonusPoints = 0;
  let offerType = '';
  
  const selectedOffer = $('#offer-type').val();
  const offerPoints = parseInt($('#offer-type option:selected').data('points') || 0);
  
  // Check if offer applies
  if (selectedOffer && ocrData.fullText.toLowerCase().includes(selectedOffer.toLowerCase())) {
    bonusPoints = offerPoints;
    offerType = selectedOffer;
  }
  
  // Submit to server
  showMessage('result-message', 'Processing receipt...', 'info');
  $('#submit-receipt').prop('disabled', true);
  
  const result = await callAPI('updateReceipt', {
    username: currentUser.username,
    storeName: ocrData.storeName,
    date: ocrData.date || '',
    total: ocrData.total,
    basePoints: basePoints,
    bonusPoints: bonusPoints,
    offerType: offerType
  });
  
  if (result.status === 'success') {
    showMessage('result-message', `
      âœ“ Receipt processed!<br>
      Points earned: ${result.pointsEarned}<br>
      New balance: ${result.newBalance}
    `, 'success');
    
    // Update UI
    $('#balance-value').text(result.newBalance);
    
    // Reset form
    setTimeout(() => {
      resetUploadForm();
      loadReceiptHistory();
    }, 3000);
    
  } else if (result.status === 'duplicate') {
    showMessage('result-message', 'This receipt was already processed', 'error');
  } else {
    showMessage('result-message', result.message || 'Error processing receipt', 'error');
  }
  
  $('#submit-receipt').prop('disabled', false);
});

function resetUploadForm() {
  $('#receipt-preview').addClass('hidden').attr('src', '');
  $('#upload-area').removeClass('hidden');
  $('#store-name-display').addClass('hidden');
  $('#receipt-image').val('');
  $('#submit-receipt').prop('disabled', true).removeData('ocr');
  $('#result-message').empty();
}

// ==============================================
// LOAD OFFERS
// ==============================================
async function loadOffers() {
  const result = await callAPI('getOffers');
  
  if (result.status === 'success') {
    const offers = result.offers || [];
    const offerSelect = $('#offer-type');
    const offersDiv = $('#active-offers');
    
    // Update dropdown
    offerSelect.empty().append('<option value="">No offer</option>');
    
    // Update offers list
    if (offers.length === 0) {
      offersDiv.html('<div class="text-muted">No offers available</div>');
    } else {
      let offersHtml = '';
      offers.forEach(offer => {
        // Add to dropdown
        offerSelect.append(`<option value="${offer.name}" data-points="${offer.points}">${offer.name} (+${offer.points} pts)</option>`);
        
        // Add to list
        offersHtml += `
          <div class="history-item">
            <strong>${offer.name}</strong>
            <span class="pull-right" style="color:#0f0;">+${offer.points} pts</span><br>
            <small>${offer.description || ''}</small>
          </div>
        `;
      });
      offersDiv.html(offersHtml);
    }
  }
}

// ==============================================
// CASHOUT SYSTEM
// ==============================================
$('#submit-cashout').on('click', async function() {
  const amount = parseInt($('#cashout-amount').val());
  const email = $('#paypal-email').val().trim();
  
  if (!amount || amount < 100) {
    showMessage('cashout-message', 'Minimum cashout is 100 points', 'error');
    return;
  }
  
  if (!email || !isValidEmail(email)) {
    showMessage('cashout-message', 'Valid PayPal email required', 'error');
    return;
  }
  
  const currentBalance = parseInt($('#balance-value').text()) || 0;
  if (amount > currentBalance) {
    showMessage('cashout-message', 'Insufficient points', 'error');
    return;
  }
  
  $('#submit-cashout').prop('disabled', true);
  showMessage('cashout-message', 'Processing cashout...', 'info');
  
  const result = await callAPI('cashout', {
    username: currentUser.username,
    amount: amount,
    method: 'PayPal',
    paypalEmail: email
  });
  
  if (result.status === 'success') {
    showMessage('cashout-message', `
      âœ“ Cashout requested!<br>
      ID: ${result.cashoutId}<br>
      New balance: ${result.newBalance}
    `, 'success');
    
    // Update balance
    $('#balance-value').text(result.newBalance);
    
  } else {
    showMessage('cashout-message', result.message || 'Cashout failed', 'error');
  }
  
  $('#submit-cashout').prop('disabled', false);
});

function isValidEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

// ==============================================
// OFFER MANAGEMENT
// ==============================================
$('#add-offer-btn').on('click', function() {
  $('#add-offer-form').toggleClass('hidden');
});

$('#save-offer').on('click', async function() {
  const name = $('#new-offer-name').val().trim();
  const points = $('#new-offer-points').val().trim();
  
  if (!name || !points) {
    alert('Please enter offer name and points');
    return;
  }
  
  const result = await callAPI('addOffer', {
    name: name,
    points: points,
    description: `Bonus offer for ${name}`,
    storeMatch: name.toLowerCase()
  });
  
  if (result.status === 'success') {
    alert('Offer added!');
    $('#new-offer-name').val('');
    $('#new-offer-points').val('');
    $('#add-offer-form').addClass('hidden');
    loadOffers();
  } else {
    alert('Error: ' + result.message);
  }
});

// ==============================================
// LOAD RECEIPT HISTORY
// ==============================================
async function loadReceiptHistory() {
  if (!currentUser) return;
  
  const result = await callAPI('getReceiptHistory', {username: currentUser.username});
  
  if (result.status === 'success') {
    const historyDiv = $('#receipt-history');
    const receipts = result.receipts || [];
    
    if (receipts.length === 0) {
      historyDiv.html('<div class="text-muted">No receipts yet</div>');
    } else {
      let html = '';
      receipts.forEach(receipt => {
        const totalPoints = (parseInt(receipt.PointsEarned) || 0);
        html += `
          <div class="history-item">
            <strong>${receipt.StoreName || 'Unknown'}</strong>
            <span class="pull-right" style="color:#0f0;">+${totalPoints}</span><br>
            <small>$${(parseFloat(receipt.TotalAmount) || 0).toFixed(2)} â€¢ ${formatDate(receipt.Timestamp)}</small>
          </div>
        `;
      });
      historyDiv.html(html);
    }
  }
}

function formatDate(dateString) {
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString();
  } catch (e) {
    return 'Unknown';
  }
}

// ==============================================
// UTILITY FUNCTIONS
// ==============================================
function showMessage(elementId, message, type = 'info') {
  const element = $('#' + elementId);
  element.html(message);
  element.removeClass().addClass('alert');
  
  if (type === 'success') {
    element.addClass('alert-success');
  } else if (type === 'error') {
    element.addClass('alert-danger');
  } else {
    element.addClass('alert-info');
  }
}

function showError(elementId, message) {
  $('#' + elementId).text(message);
}

// ==============================================
// LOGOUT
// ==============================================
$('#logout-btn').on('click', function() {
  currentUser = null;
  $('#dashboard').addClass('hidden');
  $('#login-panel').removeClass('hidden');
  $('#username').val('');
  $('#password').val('');
  resetUploadForm();
});

// ==============================================
// INITIALIZE
// ==============================================
$(document).ready(function() {
  console.log('RVT Receipts loaded');
  
  // Test connection
  callAPI('test').then(result => {
    console.log('Server test:', result);
  });
  
  // Add Bootstrap spinner CSS
  if (!$('.spinner-border').length) {
    $('head').append(`
      <style>
        .spinner-border {
          display: inline-block;
          width: 2rem;
          height: 2rem;
          vertical-align: text-bottom;
          border: 0.25em solid currentColor;
          border-right-color: transparent;
          border-radius: 50%;
          animation: spinner-border .75s linear infinite;
        }
        @keyframes spinner-border {
          to { transform: rotate(360deg); }
        }
      </style>
    `);
  }
});
</script>
</body>
</html>
